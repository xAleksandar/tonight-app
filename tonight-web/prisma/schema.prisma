generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id             String         @id @default(cuid())
  email          String         @unique
  displayName    String?
  photoUrl       String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  events         Event[]        @relation("UserEvents")
  joinRequests   JoinRequest[]
  messages       Message[]      @relation("UserMessages")
  blockedUsers   BlockedUser[]  @relation("BlockerRelation")
  blockedBy      BlockedUser[]  @relation("BlockedRelation")
  reportsFiled   Report[]       @relation("ReporterRelation")
  reportsAgainst Report[]       @relation("ReportedUserRelation")
  magicLinks     MagicLink[]
}

model Event {
  id              String            @id @default(cuid())
  title           String
  description     String
  datetime        DateTime
  location        Unsupported("geography(Point, 4326)")
  locationName    String
  maxParticipants Int               @default(2)
  status          EventStatus       @default(ACTIVE)
  hostId          String
  host            User              @relation("UserEvents", fields: [hostId], references: [id])
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  joinRequests    JoinRequest[]
  reports         Report[]          @relation("EventReportRelation")

  @@index([hostId])
  @@index([status])
}

enum EventStatus {
  ACTIVE
  EXPIRED
}

model JoinRequest {
  id         String             @id @default(cuid())
  status     JoinRequestStatus  @default(PENDING)
  eventId    String
  event      Event              @relation(fields: [eventId], references: [id])
  userId     String
  user       User               @relation(fields: [userId], references: [id])
  createdAt  DateTime           @default(now())
  updatedAt  DateTime           @updatedAt
  messages   Message[]

  @@unique([eventId, userId])
}

enum JoinRequestStatus {
  PENDING
  ACCEPTED
  REJECTED
}

model Message {
  id            String      @id @default(cuid())
  content       String
  joinRequestId String
  joinRequest   JoinRequest @relation(fields: [joinRequestId], references: [id])
  senderId      String
  sender        User        @relation("UserMessages", fields: [senderId], references: [id])
  createdAt     DateTime    @default(now())

  @@index([joinRequestId])
}

model BlockedUser {
  id         String   @id @default(cuid())
  blockerId  String
  blockedId  String
  blocker    User     @relation("BlockerRelation", fields: [blockerId], references: [id])
  blocked    User     @relation("BlockedRelation", fields: [blockedId], references: [id])
  createdAt  DateTime @default(now())

  @@unique([blockerId, blockedId])
}

model Report {
  id              String        @id @default(cuid())
  reporterId      String
  reporter        User          @relation("ReporterRelation", fields: [reporterId], references: [id])
  reportedUserId  String?
  reportedUser    User?         @relation("ReportedUserRelation", fields: [reportedUserId], references: [id])
  eventId         String?
  event           Event?        @relation("EventReportRelation", fields: [eventId], references: [id])
  reason          String
  description     String?
  status          ReportStatus  @default(PENDING)
  createdAt       DateTime      @default(now())
}

enum ReportStatus {
  PENDING
  REVIEWED
}

model MagicLink {
  id        String   @id @default(cuid())
  token     String   @unique
  email     String
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())
}
